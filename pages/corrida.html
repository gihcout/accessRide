<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AccessRide - Viajar</title>
<link rel="icon" href="/assets/img/cadeira.png">
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<style>
#map { height: 60vh; min-height: 360px; width: 100%; border-radius: 0.75rem; }
.modal-overlay { background: rgba(0,0,0,0.55); position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; z-index:10000; }
.modal-hidden { display:none; }
.spinner { border:4px solid #29382f; border-top:4px solid #38e07b; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin:0 auto 0.75rem auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.progress-bar { height:10px; border-radius:10px; background-color:#29382f; overflow:hidden; }
.progress-bar-fill { height:100%; width:0; background-color:#38e07b; transition: width 0.2s linear; }
.leaflet-routing-container { z-index:800; }
@media (max-width:640px){ #map{height:50vh;} }
</style>
</head>
<body class="bg-[#111714] min-h-screen" style='font-family:"Spline Sans","Noto Sans",sans-serif'>

<div class="relative flex flex-col min-h-screen">
  <header class="sticky top-0 z-50 w-full bg-[#111714]/80 backdrop-blur-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center gap-4 text-white">
          <span class="material-symbols-outlined text-3xl text-[#38e07b]">accessible_forward</span>
          <a href="/home.html">
            <h1 class="text-xl font-bold tracking-tight">AccessRide</h1>
        </div>
        <nav class="hidden md:flex items-center gap-8">
          <a class="text-sm font-medium text-white hover:text-white transition-colors" href="/home.html">
            Home</a>
          <a class="text-sm font-medium text-gray-300 hover:text-white transition-colors" href="./viajar.html">
            Viajar</a>
          <a class="text-sm font-medium text-gray-300 hover:text-white transition-colors"
            href="./seguran√ßa.html">Seguran√ßa</a>
          <a class="text-sm font-medium text-gray-300 hover:text-white transition-colors"
            href="./atividades.html">Atividades</a>
          <a class="text-sm font-medium text-gray-300 hover:text-white transition-colors" href="./sobre.html">
            Sobre n√≥s</a>
        </nav>
        <div class="flex items-center gap-2">
          <button
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#29382f] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-700 transition-colors">
            <a href="./login.html" class="truncate">Conecte-se</a>
          </button>
          <button
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#38e07b] text-[#111714] text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-400 transition-colors">
            <a href="./viajar.html" class="truncate">
              Solicite uma carona</a>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <section class="bg-[#1c2620] rounded-xl p-8 mb-16">
      <h2 class="text-2xl font-bold text-white mb-6">Configure sua viagem</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-white mb-2">Necessidades especiais</label>
          <select id="need" class="w-full bg-[#29382f] text-white rounded-lg p-3">
            <option>Selecione suas necessidades</option>
            <option>Cadeira de rodas</option>
            <option>Defici√™ncia visual</option>
            <option>Defici√™ncia auditiva</option>
            <option>Animal de servi√ßo</option>
            <option>Outras necessidades</option>
          </select>
        </div>
        <div>
          <label class="block text-white mb-2">Equipamentos</label>
          <select id="equip" class="w-full bg-[#29382f] text-white rounded-lg p-3">
            <option>Selecione seus equipamentos</option>
            <option>Cadeira de rodas padr√£o</option>
            <option>Cadeira de rodas el√©trica</option>
            <option>Andador</option>
            <option>Muletas</option>
            <option>Nenhum</option>
          </select>
        </div>
        <div>
          <label class="block text-white mb-2">Local de partida</label>
          <input id="partida" type="text" class="w-full bg-[#29382f] text-white rounded-lg p-3" placeholder="Digite o endere√ßo">
        </div>
        <div>
          <label class="block text-white mb-2">Local de chegada</label>
          <input id="destino" type="text" class="w-full bg-[#29382f] text-white rounded-lg p-3" placeholder="Digite o endere√ßo">
        </div>
      </div>

      <div class="mt-6">
        <label class="block text-white mb-2">Tipo de solicita√ß√£o</label>
        <select id="tipoSolicitacao" class="w-full bg-[#29382f] text-white rounded-lg p-3">
          <option value="">Selecione</option>
          <option value="flexivel">Flex√≠vel (agora)</option>
          <option value="agendar">Agendar</option>
        </select>
      </div>

      <div class="mt-6 flex gap-3">
        <button id="btnTracar" class="py-2 px-4 bg-[#38e07b] text-[#111714] font-bold rounded-lg hover:bg-green-400">Tra√ßar Rota</button>
        <button id="btnConfirm" class="py-2 px-4 bg-[#2b8cff] text-white font-bold rounded-lg hover:bg-blue-500 hidden">Confirmar Viagem</button>
        <button id="btnAjuda" class="py-2 px-4 bg-yellow-500 text-[#111714] font-bold hover:bg-yellow-400 hidden">Ajuda</button>
      </div>

      <div id="map" class="mt-6"></div>

      <div id="resultado" class="hidden mt-4 bg-[#1c2620] rounded-xl p-4 text-white">
        <p id="distancia" class="text-[#9eb7a8]"></p>
        <p id="valor" class="text-[#38e07b] text-xl font-bold"></p>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal-overlay modal-hidden">
    <div class="bg-[#1c2620] text-white rounded-xl p-6 w-80 text-center">
      <div id="modalProcurando">
        <h3 class="text-xl font-bold mb-2">Procurando motorista...</h3>
        <div class="spinner"></div>
        <p id="modalTextoBusca" class="text-[#9eb7a8]">Estamos localizando um motorista pr√≥ximo.</p>
      </div>
      <div id="modalEncontrado" class="hidden">
        <h3 class="text-2xl font-bold text-[#38e07b] mb-2">Motorista encontrado!</h3>
        <p id="infoMotorista" class="text-[#9eb7a8] mb-3">Carlos S. ‚Äî Van Acess√≠vel ‚Äî 4.9 ‚òÖ</p>
        <div class="progress-bar mb-3"><div id="progressFill" class="progress-bar-fill"></div></div>
        <p id="tempoRestante" class="text-sm text-[#9eb7a8] mb-3">Chegada em 3:00</p>
        <div class="flex justify-center gap-3">
          <button id="cancelModal" class="py-2 px-3 bg-[#ff5c5c] text-white font-bold rounded-lg">Cancelar</button>
        </div>
      </div>
      <div id="modalChegou" class="hidden">
        <h3 class="text-2xl font-bold text-[#38e07b] mb-2">O motorista chegou!</h3>
        <p class="text-[#9eb7a8]">Seu motorista est√° aguardando no local de partida.</p>
      </div>
    </div>
  </div>
</div>

<script>
const el=id=>document.getElementById(id);
const map=L.map('map').setView([-23.55,-46.63],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let partidaCoords, destinoCoords;
let control=null, motoristaMarker=null, routePolyline=null, routeCoordinates=[], animationInterval=null;

const carIcon=L.divIcon({html:"üöó",className:"",iconSize:[30,30],iconAnchor:[15,15]});

const btnTracar=el('btnTracar'), btnConfirm=el('btnConfirm'), btnAjuda=el('btnAjuda');
const modal=el('modal'), modalProcurando=el('modalProcurando'), modalEncontrado=el('modalEncontrado'), modalChegou=el('modalChegou'), modalTextoBusca=el('modalTextoBusca');
const progressFill=el('progressFill'), tempoRestante=el('tempoRestante'), infoMotorista=el('infoMotorista');

async function geocode(local){
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(local)}`);
  const data=await res.json();
  if(!data.length) throw new Error("Local n√£o encontrado");
  return [parseFloat(data[0].lat),parseFloat(data[0].lon)];
}

function escolherModelo(){
  const need=el('need').value.toLowerCase();
  const equip=el('equip').value.toLowerCase();
  if(equip.includes("cadeira")||need.includes("cadeira")) return "Minivan Acess√≠vel";
  if(equip.includes("andador")||equip.includes("muleta")||need.includes("animal")) return "SUV Adaptado";
  return "Sedan";
}

// ---------- Bot√µes ----------
function setButtonState(state){
  btnTracar.classList.toggle('hidden',state!=='preRota' && state!=='rotaTra√ßada');
  btnConfirm.classList.toggle('hidden',state!=='rotaTra√ßada');
  btnAjuda.classList.toggle('hidden',state!=='motoristaChegou');
}

// ---------- Tra√ßar rota ----------
btnTracar.addEventListener('click',async()=>{
  const partidaTxt=el('partida').value,destinoTxt=el('destino').value;
  if(!partidaTxt||!destinoTxt) return alert("Preencha partida e destino");
  [partidaCoords,destinoCoords]=await Promise.all([geocode(partidaTxt),geocode(destinoTxt)]);
  if(control) map.removeControl(control);
  control=L.Routing.control({
    waypoints:[L.latLng(...partidaCoords),L.latLng(...destinoCoords)],
    lineOptions:{styles:[{color:'#38e07b',weight:5}]},
    routeWhileDragging:false,
    createMarker:()=>null
  }).on('routesfound', e=>{
    const rota=e.routes[0];
    const distanciaKm=(rota.summary.totalDistance/1000).toFixed(2);
    const valor=(5+2.15*distanciaKm).toFixed(2);
    el('distancia').textContent=`Dist√¢ncia: ${distanciaKm} km`;
    el('valor').textContent=`Valor estimado: R$ ${valor}`;
    el('resultado').classList.remove('hidden');
    setButtonState('rotaTra√ßada');
    map.invalidateSize();
  }).addTo(map);
});

// ---------- Confirmar viagem ----------
btnConfirm.addEventListener('click',async()=>{
  const tipo=el('tipoSolicitacao').value;
  if(!tipo) return alert("Escolha tipo de solicita√ß√£o");
  const modelo=escolherModelo();
  const tempoBusca=tipo==='flexivel'?Math.floor(Math.random()*(60-20+1))+20:15;

  modal.classList.remove('modal-hidden');
  modalProcurando.classList.remove('hidden');
  modalEncontrado.classList.add('hidden');
  modalChegou.classList.add('hidden');
  modalTextoBusca.textContent=`Procurando motorista com ve√≠culo: ${modelo}...`;
  setButtonState('viagemConfirmada');

  setTimeout(async()=>{
    modalProcurando.classList.add('hidden');
    modalEncontrado.classList.remove('hidden');
    infoMotorista.textContent=`Carlos S. ‚Äî ${modelo} ‚Äî 4.9 ‚òÖ`;

    const motoristaCoords=[partidaCoords[0]+(Math.random()*0.02-0.01),partidaCoords[1]+(Math.random()*0.02-0.01)];

    const router=L.Routing.control({
      waypoints:[L.latLng(...motoristaCoords),L.latLng(...partidaCoords)],
      createMarker:()=>null,
      lineOptions:{styles:[{color:'#ffaa00',weight:4}]},
      routeWhileDragging:false,
      addWaypoints:false
    }).addTo(map);

    router.on('routesfound', e=>{
      const routeLine=L.Routing.line(e.routes[0]);
      routeCoordinates=routeLine.getLatLngs();

      if(motoristaMarker) map.removeLayer(motoristaMarker);
      motoristaMarker=L.marker(routeCoordinates[0], {icon:carIcon}).addTo(map);

      if(routePolyline) map.removeLayer(routePolyline);
      routePolyline=L.polyline([routeCoordinates[0]], {color:'#ffaa00', weight:5}).addTo(map);

      startDriverAnimation(routeCoordinates,'toPassenger');
    });
  }, tempoBusca*1000);
});

// ---------- Anima√ß√£o motorista ----------
function startDriverAnimation(coords, phase) {
  if (animationInterval) clearInterval(animationInterval);
  let index = 0, progress = 0;
  const totalPoints = coords.length;
  const duration = phase === 'toPassenger' ? 180 : 240; // segundos
  const intervalTime = 40; // ms
  let elapsed = 0;
  progressFill.style.width = '0%';

  function lerp(a, b, t) { return a + (b - a) * t; }
  function angle(a, b) { return Math.atan2(b.lat - a.lat, b.lng - a.lng) * 180 / Math.PI; }

  setButtonState('motoristaA caminho');

  animationInterval = setInterval(() => {
    if (index >= totalPoints - 1) {
      clearInterval(animationInterval);
      if (phase === 'toPassenger') {
        modalEncontrado.classList.add('hidden');
        modalChegou.classList.remove('hidden');
        setButtonState('motoristaChegou');
        // Ap√≥s alguns segundos, iniciar a viagem para destino
        setTimeout(() => {
          modalChegou.classList.add('hidden');
          startTripToDestination();
        }, 2000);
      } else {
        modal.classList.add('modal-hidden');
        alert('‚úÖ Viagem conclu√≠da! Obrigado por usar AccessRide.');
      }
      return;
    }

    progress += intervalTime / ((duration * 1000) / totalPoints);
    if (progress >= 1) { progress = 0; index++; }
    const lat = lerp(coords[index].lat, coords[index + 1].lat, progress);
    const lng = lerp(coords[index].lng, coords[index + 1].lng, progress);

    motoristaMarker.setLatLng([lat, lng]);

    // Rotacionar √≠cone conforme dire√ß√£o
    const heading = angle(coords[index], coords[index + 1]);
    motoristaMarker.getElement()?.style?.setProperty('transform', `rotate(${heading}deg)`);

    routePolyline.addLatLng([lat, lng]);
    map.panTo([lat, lng], { animate: false });

    elapsed += intervalTime / 1000;
    const remaining = Math.max(0, Math.floor(duration - elapsed));
    tempoRestante.textContent = `Chegada em ${Math.floor(remaining / 60)}:${(remaining % 60).toString().padStart(2, '0')}`;
    progressFill.style.width = `${Math.min(100, (elapsed / duration) * 100)}%`;
  }, intervalTime);
}

// ---------- Rota destino ----------
function startTripToDestination(){
  if(control) map.removeControl(control);
  L.Routing.control({
    waypoints:[L.latLng(...partidaCoords),L.latLng(...destinoCoords)],
    lineOptions:{styles:[{color:'#38e07b',weight:5}]},
    routeWhileDragging:false,
    addWaypoints:false,
    createMarker:()=>null
  }).on('routesfound',e=>{
    const routeLine=L.Routing.line(e.routes[0]);
    routeCoordinates=routeLine.getLatLngs();
    if(motoristaMarker) motoristaMarker.setLatLng(routeCoordinates[0]);
    if(routePolyline) map.removeLayer(routePolyline);
    routePolyline=L.polyline([routeCoordinates[0]],{color:'#38e07b',weight:5}).addTo(map);
    startDriverAnimation(routeCoordinates,'toDestination');
  }).addTo(map);
}

// ---------- Cancelar modal ----------
el('cancelModal').addEventListener('click',()=>{
  modal.classList.add('modal-hidden');
  if(animationInterval) clearInterval(animationInterval);
  if(motoristaMarker) { map.removeLayer(motoristaMarker); motoristaMarker=null; }
  if(routePolyline) { map.removeLayer(routePolyline); routePolyline=null; }
  alert('üö´ Corrida cancelada.');
});
</script>

</body>
</html>
